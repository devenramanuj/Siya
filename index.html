<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidushi AI - Script & Gallery Expert</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: black; font-family: 'Segoe UI', sans-serif; user-select: none; }
        
        /* --- VIDEO LAYER --- */
        #video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; display: none; }
        #silent-video { display: block; }
        
        #selfie-video { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 5; transform: scaleX(-1); border: 4px solid #ff4500; }
        canvas { display: none; }

        /* --- UI LAYER --- */
        .side-btn { position: fixed; top: 20px; right: 20px; z-index: 20; background: rgba(0,0,0,0.4); color: white; border: 1px solid rgba(255,255,255,0.2); width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; flex-direction: column; padding: 20px; box-sizing: border-box; justify-content: center; align-items: center; }
        .settings-box { background: #222; padding: 25px; border-radius: 15px; width: 90%; max-width: 350px; border: 1px solid #ff4500; color: white; text-align: center; }
        
        input, select, textarea { width: 100%; padding: 10px; margin: 10px 0; background: #333; color: white; border: 1px solid #555; border-radius: 5px; box-sizing: border-box; }
        .save-btn { width: 100%; padding: 12px; background: #ff4500; border: none; font-weight: bold; cursor: pointer; color: white; border-radius: 5px; }

        #mic-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 20; display: flex; flex-direction: column; align-items: center; width: 100%; }
        #status-text { color: white; margin-bottom: 15px; font-size: 14px; background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); }
        .controls-row { display: flex; gap: 20px; align-items: center; }
        .round-btn { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; font-size: 24px; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: 0.2s; }
        #mic-btn { width: 75px; height: 75px; background: #ff4500; }
        #gallery-btn { background: #00ff88; color: black; }
    </style>
</head>
<body>

    <div id="video-container">
        <video id="silent-video" autoplay muted loop playsinline><source src="silent.mp4" type="video/mp4"></video>
        <video id="talking-video" muted loop playsinline><source src="talking.mp4" type="video/mp4"></video>
        <video id="thinking-video" muted loop playsinline><source src="thinking.mp4" type="video/mp4"></video>
        <video id="smiling-video" muted loop playsinline><source src="smiling.mp4" type="video/mp4"></video>
    </div>
    
    <video id="selfie-video" autoplay playsinline></video>
    <canvas id="canvas-capture"></canvas>
    <input type="file" id="gallery-input" accept="image/*" style="display:none" onchange="handleGalleryUpload(event)">

    <button class="side-btn" onclick="openSettings()"><i class="fas fa-cog"></i></button>

    <div id="settings-modal" class="modal">
        <div class="settings-box">
            <h3>વિદુષી સેટિંગ્સ</h3>
            <input type="text" id="userNameInput" placeholder="તમારું નામ">
            <select id="geminiModelSelect">
                <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                <option value="gemini-3.0-flash">Gemini 3.0 Flash</option>
            </select>
            <textarea id="geminiKeyInput" rows="3" placeholder="API Keys..."></textarea>
            <button class="save-btn" onclick="saveSettings()">સેવ કરો</button>
        </div>
    </div>

    <div id="mic-container">
        <div id="status-text">જય શ્રી કૃષ્ણ</div>
        <div class="controls-row">
            <button id="gallery-btn" class="round-btn" onclick="document.getElementById('gallery-input').click()"><i class="fas fa-image"></i></button>
            <button id="mic-btn" class="round-btn" onclick="startConversation()"><i class="fas fa-microphone"></i></button>
            <button id="vision-btn" class="round-btn" style="background:#008cff" onclick="activateVision()"><i class="fas fa-camera"></i></button>
        </div>
    </div>

    <script>
        let userName = localStorage.getItem('vidushi_username') || "દેવેન્દ્રભાઈ"
        let geminiKeys = localStorage.getItem('vidushi_gemini_key') || ""
        let selectedModel = localStorage.getItem('vidushi_model') || "gemini-2.5-flash"
        
        const videos = {
            silent: document.getElementById('silent-video'),
            talking: document.getElementById('talking-video'),
            thinking: document.getElementById('thinking-video'),
            smiling: document.getElementById('smiling-video')
        }
        const statusText = document.getElementById('status-text')
        const selfieVideo = document.getElementById('selfie-video')
        const canvas = document.getElementById('canvas-capture')

        let recognition, isAiSpeaking = false, visionMode = false, currentVisionPrompt = ""

        window.onload = () => {
            playVideo('smiling')
            setTimeout(() => { speak(`જય શ્રી કૃષ્ણ ${userName} તમે ગેલેરી બટનથી મોબાઈલનો ફોટો પસંદ કરી શકો છો`) }, 1000)
        }

        function playVideo(type) {
            Object.values(videos).forEach(v => { v.style.display = 'none'; v.pause() })
            if(videos[type]) { videos[type].style.display = 'block'; videos[type].play().catch(()=>{}) }
        }

        function speak(text) {
            let clean = text.replace(/[.,!?;:*#_]/g, "")
            isAiSpeaking = true
            const u = new SpeechSynthesisUtterance(clean)
            u.lang = 'gu-IN'
            u.onstart = () => playVideo('talking')
            u.onend = () => { playVideo('smiling'); isAiSpeaking = false; setTimeout(() => { playVideo('silent') }, 3000) }
            window.speechSynthesis.speak(u)
        }

        // --- GALLERY UPLOAD LOGIC ---
        function handleGalleryUpload(event) {
            const file = event.target.files[0]
            if (!file) return
            
            const reader = new FileReader()
            reader.onload = async (e) => {
                const base64Image = e.target.result.split(',')[1]
                playVideo('thinking')
                statusText.innerText = "ગેલેરીનો ફોટો ઉકેલી રહી છું..."
                currentVisionPrompt = "આ પ્રાચીન લિપિ છે તેનું વિશ્લેષણ કરી ગુજરાતીમાં અર્થ જણાવો"
                await askGeminiVision(base64Image)
            }
            reader.readAsDataURL(file)
        }

        // --- API CALLS ---
        async function askGeminiVision(base64) {
            const keys = geminiKeys.split(',').map(k => k.trim())
            const key = keys[Math.floor(Math.random() * keys.length)]
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${key}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: currentVisionPrompt }, { inline_data: { mime_type: "image/jpeg", data: base64 } }] }] })
                })
                const data = await res.json()
                speak(data.candidates[0].content.parts[0].text)
            } catch(e) { speak("ક્ષમા કરજો ફોટો વાંચી શકાયો નથી") }
        }

        // --- OTHERS ---
        function openSettings() { document.getElementById('settings-modal').style.display = 'flex' }
        function saveSettings() {
            localStorage.setItem('vidushi_username', document.getElementById('userNameInput').value)
            localStorage.setItem('vidushi_gemini_key', document.getElementById('geminiKeyInput').value)
            localStorage.setItem('vidushi_model', document.getElementById('geminiModelSelect').value)
            location.reload()
        }
        function startConversation() { /* Voice Logic as before */ }
        async function activateVision() { /* Camera Logic as before */ }
    </script>
</body>
</html>
