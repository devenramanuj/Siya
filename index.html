<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidushi AI - Ancient Script Expert</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: black; font-family: 'Segoe UI', sans-serif; user-select: none; }
        
        /* --- VIDEO LAYER --- */
        #video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; display: none; }
        #silent-video { display: block; }
        
        #selfie-video { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 5; transform: scaleX(-1); border: 4px solid #ff4500; }
        canvas { display: none; }

        /* --- UI LAYER --- */
        .side-btn { position: fixed; top: 20px; right: 20px; z-index: 20; background: rgba(0,0,0,0.4); color: white; border: 1px solid rgba(255,255,255,0.2); width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; flex-direction: column; padding: 20px; box-sizing: border-box; justify-content: center; align-items: center; }
        .settings-box { background: #222; padding: 25px; border-radius: 15px; width: 90%; max-width: 350px; border: 1px solid #ff4500; color: white; text-align: center; }
        
        input, select, textarea { width: 100%; padding: 10px; margin: 10px 0; background: #333; color: white; border: 1px solid #555; border-radius: 5px; box-sizing: border-box; }
        .save-btn { width: 100%; padding: 12px; background: #ff4500; border: none; font-weight: bold; cursor: pointer; color: white; border-radius: 5px; }

        #mic-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 20; display: flex; flex-direction: column; align-items: center; width: 100%; }
        #status-text { color: white; margin-bottom: 15px; font-size: 14px; background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); }
        .controls-row { display: flex; gap: 20px; align-items: center; }
        .round-btn { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; font-size: 24px; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: 0.2s; }
        #mic-btn { width: 75px; height: 75px; background: #ff4500; }
        .listening { animation: pulse 1.5s infinite; background: red !important; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(255, 0, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); } }
    </style>
</head>
<body>

    <div id="video-container">
        <video id="silent-video" autoplay muted loop playsinline><source src="silent.mp4" type="video/mp4"></video>
        <video id="talking-video" muted loop playsinline><source src="talking.mp4" type="video/mp4"></video>
        <video id="thinking-video" muted loop playsinline><source src="thinking.mp4" type="video/mp4"></video>
        <video id="smiling-video" muted loop playsinline><source src="smiling.mp4" type="video/mp4"></video>
    </div>
    
    <video id="selfie-video" autoplay playsinline></video>
    <canvas id="canvas-capture"></canvas>

    <button class="side-btn" onclick="openSettings()"><i class="fas fa-cog"></i></button>

    <div id="settings-modal" class="modal">
        <div class="settings-box">
            <h3>વિદુષી સેટિંગ્સ</h3>
            <input type="text" id="userNameInput" placeholder="તમારું નામ">
            <select id="geminiModelSelect">
                <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                <option value="gemini-2.5-pro">Gemini 2.5 Pro (Best for Scripts)</option>
                <option value="gemini-3.0-flash">Gemini 3.0 Flash</option>
            </select>
            <textarea id="geminiKeyInput" rows="3" placeholder="Gemini API Keys (કોમા થી અલગ કરો)"></textarea>
            <button class="save-btn" onclick="saveSettings()">સેવ કરો</button>
        </div>
    </div>

    <div id="mic-container">
        <div id="status-text">જય શ્રી કૃષ્ણ</div>
        <div class="controls-row">
            <button id="vision-btn" class="round-btn" style="background:#008cff" onclick="activateVision()"><i class="fas fa-camera"></i></button>
            <button id="mic-btn" class="round-btn" onclick="startConversation()"><i class="fas fa-microphone"></i></button>
            <button id="stop-btn" class="round-btn" style="background:#444" onclick="stopConversation()"><i class="fas fa-stop"></i></button>
        </div>
    </div>

    <script>
        // --- INITIAL CONFIG ---
        let userName = localStorage.getItem('vidushi_username') || "દેવેન્દ્રભાઈ"
        let geminiKeys = localStorage.getItem('vidushi_gemini_key') || ""
        let selectedModel = localStorage.getItem('vidushi_model') || "gemini-2.5-flash"
        let chatHistory = []
        
        const videos = {
            silent: document.getElementById('silent-video'),
            talking: document.getElementById('talking-video'),
            thinking: document.getElementById('thinking-video'),
            smiling: document.getElementById('smiling-video')
        }
        const statusText = document.getElementById('status-text')
        const micBtn = document.getElementById('mic-btn')
        const selfieVideo = document.getElementById('selfie-video')
        const canvas = document.getElementById('canvas-capture')

        let recognition, isProcessing = false, isAiSpeaking = false, visionMode = false, currentVisionPrompt = ""

        // --- STARTUP ---
        window.onload = () => {
            playVideo('smiling')
            setTimeout(() => { speak(`જય શ્રી કૃષ્ણ ${userName} હું તમારી સેવામાં તૈયાર છું આજે આપણે કઈ હસ્તલિપિ ઉકેલવી છે`) }, 1000)
        }

        function playVideo(type) {
            Object.values(videos).forEach(v => { v.style.display = 'none'; v.pause() })
            if(videos[type]) { videos[type].style.display = 'block'; videos[type].play().catch(()=>{}) }
        }

        // --- SPEECH WITHOUT PUNCTUATION ---
        function speak(text) {
            let clean = text.replace(/[.,!?;:*#_]/g, "") // તમામ ચિહ્નો દૂર કર્યા
            statusText.innerText = "વિદુષી બોલે છે..."
            isAiSpeaking = true
            const u = new SpeechSynthesisUtterance(clean)
            u.lang = 'gu-IN'
            u.onstart = () => playVideo('talking')
            u.onend = () => {
                playVideo('smiling')
                isAiSpeaking = false
                setTimeout(() => { if(!isProcessing) playVideo('silent') }, 3000)
                statusText.innerText = "માઈક દબાવો"
            }
            window.speechSynthesis.speak(u)
        }

        // --- VOICE RECOGNITION ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition
        if(SpeechRecognition) {
            recognition = new SpeechRecognition()
            recognition.lang = 'gu-IN'
            recognition.onstart = () => { micBtn.classList.add('listening'); statusText.innerText = "સાંભળું છું..." }
            recognition.onend = () => micBtn.classList.remove('listening')
            recognition.onresult = (e) => processCommand(e.results[0][0].transcript)
        }

        function startConversation() { if(!isAiSpeaking) try{recognition.start()}catch(e){} }
        function stopConversation() { recognition.stop(); window.speechSynthesis.cancel(); playVideo('silent'); isProcessing = false }

        // --- VISION HANDLING ---
        async function activateVision() {
            if(visionMode) { captureAndAnalyze(); return }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                selfieVideo.srcObject = stream
                selfieVideo.style.display = 'block'
                visionMode = true
                statusText.innerText = "હસ્તપ્રત સામે રાખો"
                speak("કૃપા કરીને લિપિનો સ્પષ્ટ ફોટો બતાવો")
            } catch(e) { alert("કેમેરો ખુલતો નથી") }
        }

        async function captureAndAnalyze() {
            canvas.width = selfieVideo.videoWidth
            canvas.height = selfieVideo.videoHeight
            canvas.getContext('2d').drawImage(selfieVideo, 0, 0)
            
            // કેમેરો બંધ કરી વીડિયો ચાલુ કરવો
            const tracks = selfieVideo.srcObject.getTracks()
            tracks.forEach(track => track.stop())
            selfieVideo.style.display = 'none'
            visionMode = false
            
            playVideo('thinking')
            statusText.innerText = "લિપિ ઉકેલી રહી છું..."
            
            const base64Image = canvas.toDataURL('image/jpeg', 0.5).split(',')[1]
            if(!currentVisionPrompt) currentVisionPrompt = "આ હસ્તલિપિ કઈ છે તે ઓળખી તેનું ગુજરાતીમાં ભાષાંતર કર"
            
            await askGeminiVision(base64Image)
        }

        // --- COMMAND PROCESSING ---
        async function processCommand(text) {
            let cmd = text.toLowerCase()
            isProcessing = true
            playVideo('thinking')

            if(cmd.includes("લિપિ") || cmd.includes("ઉકેલ") || cmd.includes("વાંચ")) {
                currentVisionPrompt = "તું એક પ્રાચીન લિપિ નિષ્ણાત છે આ હસ્તપ્રત કઈ લિપિમાં છે તે જણાવ (બ્રાહ્મી મોડી કે શારદા) અને તેનું ગુજરાતીમાં શબ્દશઃ ભાષાંતર કરી તેનો અર્થ સમજાવ"
                activateVision()
                return
            }

            const sysPrompt = `તારું નામ વિદુષી છે તું સનાતન ધર્મની જ્ઞાની છે ગુજરાતીમાં પંચ્યુએશન વગર જવાબ આપજે યુઝરનું નામ ${userName} છે`
            await askGeminiText(text, sysPrompt)
        }

        // --- AI API CALLS ---
        async function askGeminiText(uText, sPrompt) {
            const keys = geminiKeys.split(',').map(k => k.trim())
            const key = keys[Math.floor(Math.random() * keys.length)]
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${key}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: sPrompt + "\nUser: " + uText }] }] })
                })
                const data = await res.json()
                speak(data.candidates[0].content.parts[0].text)
            } catch(e) { speak("ક્ષમા કરજો કનેક્શનમાં સમસ્યા છે") }
        }

        async function askGeminiVision(base64) {
            const keys = geminiKeys.split(',').map(k => k.trim())
            const key = keys[Math.floor(Math.random() * keys.length)]
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${key}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: currentVisionPrompt }, { inline_data: { mime_type: "image/jpeg", data: base64 } }] }] })
                })
                const data = await res.json()
                speak(data.candidates[0].content.parts[0].text)
                currentVisionPrompt = ""
            } catch(e) { speak("ફોટો વાંચવામાં ભૂલ થઈ રહી છે") }
        }

        // --- SETTINGS ---
        function openSettings() { 
            document.getElementById('settings-modal').style.display = 'flex'
            document.getElementById('userNameInput').value = userName
            document.getElementById('geminiKeyInput').value = geminiKeys
            document.getElementById('geminiModelSelect').value = selectedModel
        }
        function saveSettings() {
            localStorage.setItem('vidushi_username', document.getElementById('userNameInput').value)
            localStorage.setItem('vidushi_gemini_key', document.getElementById('geminiKeyInput').value)
            localStorage.setItem('vidushi_model', document.getElementById('geminiModelSelect').value)
            location.reload()
        }
    </script>
</body>
</html>
